[프로젝트: My Factory] 통합 개발 상세 명세서 (Final Ver 7.0)
1. 프로젝트 개요
플랫폼/엔진: PC / Unity (2D)

장르: 공장 자동화 시뮬레이션 (샌드박스)

핵심 루프: 자원 설정(Source) → 투입기(능동) → 벨트(수동) → 투입기 → 기계 가공(Recipe) → 납품

개발 목표:

Tick(Logic)과 Update(Visual)의 분리: 데이터 연산과 렌더링의 완벽한 분리.

능동적 물류: 모든 아이템의 In/Out은 '투입기'가 주도.

확장성: JSON 기반의 유연한 데이터 구조 및 저장 시스템.

2. 맵 및 그리드 시스템 (Grid System)
2.1. 맵 데이터 구조
크기: 50 x 50 (고정)

좌표계: Vector2Int(x, y) 정수 좌표.

데이터 관리: Building[,] 2차원 배열 + List<Building> (활성 객체 관리용).

[Update] 멀티 타일 처리 (Pivot Rule):

기준점: 모든 건물은 **좌측 하단(x, y)**을 기준점(Pivot)으로 함.

점유 처리: 2x2 건물 설치 시 (x, y)에는 실제 객체(Instance)를 저장하고, (x+1, y), (x, y+1), (x+1, y+1)에는 참조(Reference) 혹은 더미(Dummy) 값을 넣어 중복 설치 방지.

2.2. 조작 및 카메라 (Controls)
건설/제거: 좌클릭 건설, 우클릭 제거. (비용 없음/샌드박스 모드)

회전: 'R' 키 입력 시 시계 방향 90도 회전. (Ghost 상태에서도 회전 반영)

설정 변경: 설치된 건물(Source, Machine) 클릭 시 설정 UI 팝업.

카메라: WASD 이동, 휠 줌인/아웃, 맵 밖 이동 제한(Clamp).

2.3. 시각화 (Visual Feedback)
고스트(Ghost): 마우스 커서 위치에 반투명 미리보기 + 설치 불가 지역(충돌) 시 붉은색 틴트(Red Tint).

UI 레이어: 팝업 UI는 게임 화면 최상단에 위치하며, UI가 열려있을 때는 맵 클릭 방지 (EventSystem 체크).

3. 핵심 게임 로직 (Core Logic)
3.1. 시간 및 이동 시스템 ([Update] Faster Tick)
Logic (OnTick):

주기: 0.1초 (100ms) 권장. (기존 0.5초는 시뮬레이션이 너무 둔탁함).

역할: 아이템의 논리적 위치 변경, 기계의 생산 게이지 증가, 투입기 상태 변경.

Render (Update):

주기: 매 프레임 (60 FPS+).

보간(Interpolation): Vector3.Lerp(currentPos, targetPos, t)를 사용하여, 0.1초 간격의 틱 사이를 부드럽게 연결.

Anti-Teleport: 한 틱에 아이템은 최대 1칸(혹은 정해진 거리)만 이동.

3.2. 세이브/로드 시스템 ([Update] Full State Save)
형식: JSON 포맷.

[중요] 저장 데이터 구조 개선: 건물 정보뿐만 아니라 '보유 아이템' 정보 필수 포함.

JSON

{
  "buildings": [
    {
      "type": "Belt", "x": 10, "y": 10, "dir": 1,
      "items": [ { "itemId": 101, "progress": 0.5 } ] // 벨트 위 아이템 위치
    },
    {
      "type": "Assembler", "x": 12, "y": 12, "dir": 0,
      "recipeId": "R3",
      "inventory": {
         "inputs": [ { "id": 201, "count": 2 } ],
         "outputs": [ { "id": 301, "count": 1 } ]
      }
    }
  ]
}
로드 프로세스 (Two-Pass):

Instantiate: JSON을 파싱하여 모든 건물을 좌표에 생성 및 배치.

Restore & Link: 생성된 건물의 인벤토리 복구, 투입기의 앞/뒤 건물 참조 연결(Link).

4. 물류 및 생산 시스템 (Logistics)
4.1. 컨베이어 벨트 (Conveyor Belt)
역할: 수동적 운송. 아이템을 스스로 밀지 않음(벨트 로직에 의해 아이템 좌표가 갱신됨).

[Update] Auto-Tiling:

인접 벨트의 방향을 비트마스크로 체크하여 직선, 곡선(Corner) 스프라이트 자동 교체.

곡선 구간 로직: 시각적으로는 곡선이지만, 논리적으로는 해당 타일 진입 → 방향 전환 → 다음 타일 진출 순서로 처리.

4.2. 투입기 (Inserter) - [Update] 상세 FSM
구조: Source Grid(집는 곳) / Destination Grid(놓는 곳).

FSM (상태 머신):

Idle: 집을 물건이 없거나 놓을 곳이 꽉 차면 대기.

MoveToPick: 집게가 Source 방향으로 이동.

Pick: 아이템 1개 획득 (Source 인벤토리 차감).

MoveToDrop: 아이템을 들고 Destination 방향으로 회전/이동.

Drop: 아이템 투입 (Destination 인벤토리/벨트에 추가).

필터링 규칙: 기계에서 물건을 꺼낼 때는 **'Output Slot'**에 있는 완성품만 꺼냄 (재료 꺼내기 금지).

4.3. 생산 기계 (Smelter/Assembler)
입력 창고 (Source): 아이템 종류 선택, 무한 모드/버퍼 모드 설정.

조립기/제련기:

레시피 필수: 레시피가 선택되지 않으면 작동 불가.

슬롯 구분: Input Slot(재료)과 Output Slot(완성품)이 엄격히 분리됨.

5. 데이터 명세 (Data Specs)
5.1. 아이템 및 레시피 (예시)
Items: Iron Ore(101), Copper Ore(102), Iron Ingot(201), Copper Wire(204), Circuit(301) 등.

Recipes:

R1 (Smelter): Iron Ore(1) → 2s → Iron Ingot(1)

R5 (Assembler): Iron Plate(1) + Copper Wire(2) → 5s → Circuit(1)

6. 그래픽 및 리소스 가이드 ([Update] Art Guide)
6.1. 스프라이트 규격
PPU (Pixels Per Unit): 32 or 64 (타일 크기에 맞춰 통일).

레이어 (Sorting Order):

Order 0: 바닥 (Floor)

Order 1: 벨트 (Belt)

Order 2: 아이템 (Item) - 벨트 위에 그려져야 함.

Order 3: 건물 본체 (Machine Base), 투입기 바닥

Order 4: 투입기 팔 (Inserter Arm) - [중요] 아이템보다 위에 그려져야 함.

Order 5: 비행 UI, 고스트

6.2. 리소스 제작 요청 사항
벨트: 수직, 수평, 코너(4방향) - 총 6개 기본 타일 필요.

투입기: **Base(고정부)**와 Arm/Head(회전부) 이미지를 반드시 분리해서 제작.

아이템: 벨트 위에서 식별 가능한 단순하고 명확한 아이콘.

7. QA 및 예외 처리 규칙 (Edge Case Rules)
Merge (합류): 두 벨트가 하나로 합쳐질 때, 동시에 진입하면 기존 벨트 위의 아이템이 우선권(Priority)을 가짐. 진입하려는 아이템은 대기.

Full Output: 기계의 Output Slot이 꽉 차면 생산을 즉시 중단(Pause).

Recipe Change: 기계 작동 중 레시피를 바꾸면, 내부에 있던 기존 재료/생산품은 반환되거나 소멸 처리 (오류 방지).

Disconnect: 투입기가 설치된 상태에서 앞/뒤 건물이 삭제되면, 투입기는 즉시 Idle 상태로 전환되며 작업을 멈춤.

8. [Action Item] 파트별 작업 우선순위
Programmer:

GridManager (2D 배열 관리) 및 기본 Save/Load 구현.

0.1s Tick System 구축.

Inserter FSM 구현 (가장 복잡한 로직).

Designer:

아이템 아이콘 및 벨트(직선/코너) 스프라이트 우선 제작.

투입기(Base/Arm 분리) 리소스 제작.